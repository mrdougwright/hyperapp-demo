<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="/style.css" />
    <script type="module">
      import { h, app } from 'https://unpkg.com/hyperapp'

      // -- EFFECTS & SUBSCRIPTIONS --

      // -- ACTIONS --
      const StartEditingFilter = (state) => ({
        ...state,
        editingFilter: true,
      })
      const StopEditingFilter = (state) => ({
        ...state,
        editingFilter: false,
      })
      const SetFilter = (state, word) => ({
        ...state,
        filter: word,
      })
      const SelectStory = (state, id) => ({
        ...state,
        reading: id,
        stories: {
          ...state.stories,
          [id]: {
            ...state.stories[id],
            seen: true,
          },
        },
      })

      // -- VIEWS ---
      const emphasize = (word, string) =>
        string
          .split(' ')
          .map((x) =>
            x.toLowerCase() === word.toLowerCase()
              ? h('em', {}, x + ' ')
              : x + ' '
          )

      const storyThumbnail = (props) =>
        h(
          'li',
          {
            // length- 2 array with the action first and the custom payload second.
            onclick: [SelectStory, props.id],
            class: {
              unread: props.unread,
              reading: props.reading,
            },
          },
          [
            h('p', { class: 'title' }, emphasize(props.filter, props.title)),
            h('p', { class: 'author' }, props.author),
          ]
        )

      const storyList = (props) =>
        h('div', { class: 'stories' }, [
          h(
            'ul',
            {},
            Object.keys(props.stories).map((id) =>
              storyThumbnail({
                id,
                title: props.stories[id].title,
                author: props.stories[id].author,
                unread: !props.stories[id].seen,
                reading: props.reading === id,
                filter: props.filter,
              })
            )
          ),
        ])

      const filterView = (props) =>
        h('div', { class: 'filter' }, [
          'Filter:',

          props.editingFilter
            ? h('input', {
                type: 'text',
                value: props.filter,
                // length- 2 array with action first and custom `payload filter` second.
                // use Payload filters when you need a payload that is a combination of custom data and event data
                oninput: [SetFilter, (event) => event.target.value],
              })
            : h('span', { class: 'filter-word' }, props.filter),

          props.editingFilter
            ? h('button', { onclick: StopEditingFilter }, '\u2713')
            : h('button', { onclick: StartEditingFilter }, '\u270E'),
        ])

      const storyDetail = (props) =>
        h('div', { class: 'story' }, [
          props && h('h1', {}, props.title),
          props &&
            h(
              'p',
              {},
              `Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, qui nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.`
            ),
          props && h('p', { class: 'signature' }, props.author),
        ])

      const autoUpdateView = (props) =>
        h('div', { class: 'autoupdate' }, [
          'Auto update: ',
          h('input', { type: 'checkbox' }),
        ])

      const container = (content) => h('div', { class: 'container' }, content)

      // -- RUN --
      app({
        init: {
          filter: 'ocean',
          reading: '112',
          stories: {
            '112': {
              title: 'The Ocean is Sinking',
              author: 'Kat Stropher',
              seen: true,
            },
            '113': {
              title: 'Ocean life is brutal',
              author: 'Surphy McBrah',
              seen: false,
            },
            '114': {
              title: 'Family friendly fun at the ocean exhibit',
              author: 'Guy Prosales',
              seen: false,
            },
          },
        },
        node: document.getElementById('app'),
        view: (state) =>
          container([
            filterView(state),
            h('div', { class: 'row' }, [
              storyList(state),
              storyDetail(state.reading && state.stories[state.reading]),
            ]),
            autoUpdateView(state),
          ]),
      })
    </script>
  </head>

  <body>
    <div id="app"></div>
  </body>
</html>
